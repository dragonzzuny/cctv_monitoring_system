# backend/app/core/roi_manager.py

## 역할
ROI(관심영역) 관리. DB에서 ROI 로드, Shapely 폴리곤 기반 포인트-인-폴리곤 검사, 좌표 정규화.

## 핵심 알고리즘
- **좌표 정규화 휴리스틱**: 좌표값 > 1.1이면 픽셀 좌표로 간주, 1280x720 또는 1920x1080 해상도 기반 정규화
- **is_detection_in_roi()**: 탐지 박스의 foot point (하단 중앙)가 ROI 폴리곤 내부에 있는지 Shapely contains()로 확인
- **기본 탐지 해상도 폴백**: 640x360 (해상도 정보 없을 때)

## 입출력
- **입력**: camera_id, DB session → ROI 목록 로드
- **출력**: ROI 폴리곤 리스트, 포인트-인-폴리곤 검사 결과

## 리스크
- HIGH: 좌표 정규화 휴리스틱 — 1280x720, 1920x1080 이외 해상도에서 오작동
- MEDIUM: 전역 싱글턴(get_roi_manager)과 WebSocket별 인스턴스 이중 구조 — 상태 불일치
- MEDIUM: 640x360 폴백 해상도 — 실제 해상도와 다르면 ROI 위치 부정확
- LOW: load_rois()가 async DB 세션 필요 — 호출 컨텍스트 제한

## 수정 포인트
- 해상도를 카메라 설정에서 가져오기 (휴리스틱 제거)
- 전역 싱글턴 제거, DI로 전환

## 테스트 제안
- 다양한 해상도에서 좌표 정규화 테스트
- 폴리곤 내부/외부/경계 탐지 테스트
- 유효하지 않은 폴리곤 처리 테스트
